---
# Example hiera configuration.
version: 5

defaults:
  datadir: .
  data_hash: yaml_data

hierarchy:

    - name: "Per-node secrets (eyaml)"
      lookup_key: eyaml_lookup_key # eyaml backend
      options:
          pkcs7_private_key: /etc/puppetlabs/puppet/keys/private_key.pkcs7.pem
          pkcs7_public_key:  /etc/puppetlabs/puppet/keys/public_key.pkcs7.pem
      paths:
          - "data/%{trusted.certname}.eyaml"

          # As per hiera merging this order is correct as the higher stuff on the list overwrites the lower if keys share the same name:
          # https://puppet.com/docs/hiera/3.3/lookup_types.html#native-merging
          - "data/services/%{trusted.extensions.pp_service}/%{trusted.extensions.pp_environment}/%{trusted.extensions.pp_role}/%{trusted.certname}.eyaml"
          - "data/services/%{trusted.extensions.pp_service}/%{trusted.extensions.pp_environment}/%{trusted.certname}.eyaml"
          - "data/services/%{trusted.extensions.pp_service}/%{trusted.extensions.pp_environment}/%{trusted.extensions.pp_role}.eyaml"
          - "data/services/%{trusted.extensions.pp_service}/%{trusted.extensions.pp_environment}/common.eyaml"
          - "data/services/%{trusted.extensions.pp_service}/%{trusted.extensions.pp_role}.eyaml"
          - "data/services/%{trusted.extensions.pp_service}/common.eyaml"

    - name: "Common data (yaml version)"
      paths:
          - "data/common.yaml"

    - name: "Common secrets (eyaml)"
      lookup_key: eyaml_lookup_key
      options:
          pkcs7_private_key: /etc/puppetlabs/puppet/keys/private_key.pkcs7.pem
          pkcs7_public_key:  /etc/puppetlabs/puppet/keys/public_key.pkcs7.pem
      paths:
          - "data/common.eyaml"
